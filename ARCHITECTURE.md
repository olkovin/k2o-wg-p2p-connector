# Architecture

Technical design document for k2o-wg-p2p-connector.

## Design Goals

1. **Single script** — same file works on both server and client
2. **Automatic key exchange** — no manual intervention required
3. **One adoption at a time** — server handles only one pending connection
4. **Clean removal** — all entities can be removed by tunnel ID
5. **Fallback to manual** — if automation fails, show instructions

## Configuration Structure

```routeros
# ═══════════════════════════════════════════════════════════════════
#  BASIC CONFIGURATION (required)
# ═══════════════════════════════════════════════════════════════════

:global p2pRole "server"                    # "server" or "client"
:global p2pServerAddress "1.2.3.4"          # Public IP/FQDN of server
:global p2pSstpPass "ChangeThisPassword!"   # Key exchange password

# ═══════════════════════════════════════════════════════════════════
#  MAIN CONFIGURATION (with defaults)
# ═══════════════════════════════════════════════════════════════════

:global p2pTunnelName "tunnel1"             # Short tunnel identifier
:global p2pServerWgIP "10.200.0.1"          # Server WG IP
:global p2pClientWgIP "10.200.0.2"          # Client WG IP
:global p2pWgNetmask "/30"                  # Network mask

# ═══════════════════════════════════════════════════════════════════
#  ADVANCED CONFIGURATION (optional)
# ═══════════════════════════════════════════════════════════════════

:global p2pWgPort 51820                     # WireGuard UDP port
:global p2pSstpPort 443                     # SSTP TCP port
:global p2pSstpUser "p2p-k2o-exchange"      # SSTP username
:global p2pTimeout 300                      # Timeout (seconds)
```

## Naming Convention

| Entity | Pattern | Example |
|--------|---------|---------|
| WG Interface | `wg-p2p-k2o-{name}-{id}` | `wg-p2p-k2o-office-20251206173000` |
| WG Peer | `wg-p2p-k2o-peer-{id}` | `wg-p2p-k2o-peer-20251206173000` |
| Remove script | `remove-p2p-k2o-{id}` | `remove-p2p-k2o-20251206173000` |
| Finalize script | `p2p-k2o-finalize` | (no ID, only one at a time) |
| Cancel script | `p2p-k2o-cancel` | (no ID, only one at a time) |
| PPP secret (temp) | `p2p-k2o-{id}` | `p2p-k2o-20251206173000` |
| PPP profile (temp) | `p2p-k2o-profile-{id}` | `p2p-k2o-profile-20251206173000` |
| Register script (temp) | `p2p-k2o-register-{id}` | `p2p-k2o-register-20251206173000` |

## Comment Marker

All created entities have this comment format:
```
Generated by k2o-wg-p2p-connector | k2o.cc | ID:20251206173000 | 06.12.2025 17:30:00
```

## Tunnel ID Format

```
YYYYMMDDHHMMSS
```

Example: `20251206173000` = 2025-12-06 17:30:00

- Generated on **server** at adoption start
- Synchronized to **client** during SSTP key exchange
- Used to identify all entities for removal

## Single Adoption Mechanism

Only one adoption process can be active on server at a time.

```routeros
# Global state variables (server only)
:global p2pAdoptionActive false
:global p2pAdoptionID ""
:global p2pAdoptionServerPubkey ""

# Check before starting new adoption
:if ($p2pAdoptionActive) do={
    :put "ERROR: Another adoption in progress (ID: $p2pAdoptionID)"
    :put "Run: /system script run p2p-k2o-cancel"
    :error "Adoption already active"
}

# Set active
:set p2pAdoptionActive true
:set p2pAdoptionID $tunnelID
:set p2pAdoptionServerPubkey $myPubkey

# Clear on completion/timeout/cancel
:set p2pAdoptionActive false
```

## Detailed Flow

### Server Flow

```
1. VALIDATION
   ├─ Check if adoption already active → ERROR if yes
   └─ Validate configuration

2. INITIALIZATION
   ├─ Generate Tunnel ID (YYYYMMDDHHMMSS)
   ├─ Set p2pAdoptionActive = true
   └─ Calculate comment marker

3. CREATE WIREGUARD
   ├─ Create WG interface: wg-p2p-k2o-{name}-{id}
   ├─ Add IP address: {serverWgIP}/30
   └─ Get public key

4. CREATE SSTP SERVER
   ├─ Create PPP profile: p2p-k2o-profile-{id}
   │   └─ local-address=10.254.254.1, remote-address=10.254.254.2
   ├─ Create PPP secret: p2p-k2o-{id}
   │   └─ user={sstpUser}, password={sstpPass}
   └─ Enable SSTP server on port {sstpPort}

5. CREATE HELPER SCRIPTS
   ├─ p2p-k2o-register-{id}
   │   └─ Called by client via SSH, returns server pubkey + ID
   ├─ p2p-k2o-finalize
   │   └─ Manual fallback for adding peer
   └─ p2p-k2o-cancel
       └─ Cancel active adoption

6. WAIT FOR CLIENT
   ├─ Poll for p2pReceivedPubkey (5 min timeout)
   ├─ Show progress every 30 seconds
   └─ On timeout → cleanup and exit

7. ON CLIENT CONNECTED
   ├─ Receive client pubkey via registration script
   ├─ Add WG peer: wg-p2p-k2o-peer-{id}
   └─ Add firewall rule (accept UDP {wgPort})

8. CLEANUP
   ├─ Disable SSTP server
   ├─ Remove PPP secret
   ├─ Remove PPP profile
   ├─ Remove registration script
   ├─ Remove finalize/cancel scripts
   └─ Set p2pAdoptionActive = false

9. FINALIZE
   ├─ Generate remove-p2p-k2o-{id} script
   └─ Show success message
```

### Client Flow

```
1. VALIDATION
   └─ Validate configuration

2. CREATE WIREGUARD
   ├─ Create WG interface: wg-p2p-k2o-{name}-{id}
   │   └─ ID will be updated after exchange
   ├─ Add IP address: {clientWgIP}/30
   └─ Get public key

3. CONNECT TO SSTP
   ├─ Create SSTP client to {serverAddress}:{sstpPort}
   ├─ Wait for connection (60 sec timeout)
   └─ On failure → show manual exchange instructions

4. EXCHANGE KEYS
   ├─ Execute SSH command on server (10.254.254.1)
   │   └─ :global p2pClientPubkeyReceived "{myPubkey}"
   │   └─ /system script run p2p-k2o-register-{serverID}
   ├─ Parse response:
   │   └─ SERVER_PUBKEY: {pubkey}
   │   └─ TUNNEL_ID: {id}
   └─ On failure → show manual exchange instructions

5. DISCONNECT SSTP
   └─ Remove SSTP client interface

6. ADD PEER
   └─ Add WG peer: wg-p2p-k2o-peer-{id}
       ├─ endpoint-address={serverAddress}
       ├─ endpoint-port={wgPort}
       └─ persistent-keepalive=25s

7. FINALIZE
   ├─ Rename WG interface with correct ID
   ├─ Update comments with correct ID
   ├─ Generate remove-p2p-k2o-{id} script
   └─ Show success message
```

## Firewall Integration

Server automatically adds WireGuard accept rule:

```routeros
# Find first drop/reject rule in input chain
:local dropRules [/ip firewall filter find where chain="input" action~"drop|reject" !disabled]
:if ([:len $dropRules] > 0) do={
    :local firstDrop [:pick $dropRules 0]
    /ip firewall filter add \
        chain=input \
        protocol=udp \
        dst-port=$p2pWgPort \
        action=accept \
        comment=$p2pComment \
        place-before=$firstDrop
}
```

## Manual Fallback

If automatic key exchange fails:

### On Server
```
═══════════════════════════════════════════════════════════════════
  MANUAL KEY EXCHANGE
═══════════════════════════════════════════════════════════════════

  SERVER PUBLIC KEY:
  +ABC123...XYZ=

  Waiting for client public key...

  When you have client's key, run:
  :global p2pClientPubkey "+CLIENT_KEY_HERE="
  /system script run p2p-k2o-finalize
═══════════════════════════════════════════════════════════════════
```

### On Client
```
═══════════════════════════════════════════════════════════════════
  MANUAL KEY EXCHANGE
═══════════════════════════════════════════════════════════════════

  CLIENT PUBLIC KEY:
  +DEF456...ABC=

  1. Copy this key to SERVER router
  2. Get server's public key
  3. On THIS router run:
     :global p2pServerPubkey "+SERVER_KEY_HERE="
     /system script run p2p-k2o-finalize
═══════════════════════════════════════════════════════════════════
```

## Remove Script

Generated on both server and client:

```routeros
# remove-p2p-k2o-{id}
:local tunnelID "{id}"
:local marker "ID:$tunnelID"

:put "Removing P2P tunnel: $tunnelID"
:log warning "P2P-WG: Removing tunnel $tunnelID"

# Remove WG peers
:do { /interface wireguard peers remove [find where comment~$marker] } on-error={}

# Remove IP addresses
:do { /ip address remove [find where comment~$marker] } on-error={}

# Remove firewall rules
:do { /ip firewall filter remove [find where comment~$marker] } on-error={}

# Remove routes
:do { /ip route remove [find where comment~$marker] } on-error={}

# Remove WG interface
:do { /interface wireguard remove [find where comment~$marker] } on-error={}

# Remove this script
:do { /system script remove [find where comment~$marker] } on-error={}

:put "Tunnel $tunnelID removed!"
:log warning "P2P-WG: Tunnel $tunnelID removed"
```

## Error Handling

| Error | Server Action | Client Action |
|-------|--------------|---------------|
| Adoption already active | Show error, suggest cancel | N/A |
| SSTP connection failed | N/A | Show manual exchange |
| SSH execution failed | N/A | Show manual exchange |
| Key exchange timeout | Cleanup, show manual | Show manual exchange |
| WG interface creation failed | Fatal error | Fatal error |

## File Structure

```
k2o-wg-p2p-connector/
├── README.md              # English documentation
├── README.uk.md           # Ukrainian documentation
├── ARCHITECTURE.md        # This file
├── wg-p2p-connector.rsc   # Main script
├── LICENSE                # MIT License
└── .gitignore
```
